오류
Uncaught (in promise) ReferenceError: sortNotes is not defined
컨텍스트
sidepanel.html
스택 추적
src/main.js:48 (익명의 함수)
1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
// Initialize the database when the script loads
initDB().then(() => {
  loadAndMigrateData();
  cleanupDeletedImages();
}).catch(err => console.error("Failed to initialize DB:", err));

async function loadAndMigrateData() {
  // Load settings from storage
  chrome.storage.local.get(['globalSettings', 'notes', 'deletedNotes'], async (data) => {
    const loadedSettings = data.globalSettings;
    if (loadedSettings) {
      globalSettings = loadedSettings;
    } else {
      globalSettings = {
        title: 'default',
        fontSize: 12,
        autoLineBreak: true,
        tildeReplacement: true,
        autoAddSpaces: true,
        preventUsedImageDeletion: true,
        mode: 'system'
      };
    }

    const loadedNotes = data.notes;
    const loadedDeletedNotes = data.deletedNotes;

    // One-time migration from chrome.storage.local to IndexedDB
    if (loadedNotes || loadedDeletedNotes) {
      const allNotesToMigrate = (loadedNotes || []).concat(loadedDeletedNotes || []);
      if (allNotesToMigrate.length > 0) {
        try {
          for (const note of allNotesToMigrate) {
            await saveNote(note);
          }
          chrome.storage.local.remove(['notes', 'deletedNotes']);
        } catch (err) {
          console.error("Failed to migrate notes to IndexedDB:", err);
        }
      }
    }

    // Load all notes from IndexedDB
    const allNotesFromDB = await getAllNotes();
    notes = allNotesFromDB.filter(note => !note.metadata.deletedAt);
    deletedNotes = allNotesFromDB.filter(note => note.metadata.deletedAt);

    sortNotes();
    renderNoteList();
    applyMode(globalSettings.mode);
    cleanupDeletedNotes();
  });
}

async function cleanupDeletedImages() {
    const thirtyDaysAgo = Date.now() - 30 * 24 * 60 * 60 * 1000;
    const imageObjects = await getAllImageObjectsFromDB();
    const imagesToDelete = imageObjects.filter(img => img.deletedAt && img.deletedAt < thirtyDaysAgo);
    for (const image of imagesToDelete) {
        await deleteImagePermanently(image.id);
    }
}

async function cleanupDeletedNotes() {
    const thirtyDaysAgo = Date.now() - 30 * 24 * 60 * 60 * 1000;
    const notesToDelete = deletedNotes.filter(note => note.metadata.deletedAt < thirtyDaysAgo);
    for (const note of notesToDelete) {
        await deleteNotePermanentlyDB(note.id);
    }
    deletedNotes = deletedNotes.filter(note => note.metadata.deletedAt >= thirtyDaysAgo);
}

showListView();


// Initial setup
updateAutoLineBreakButton();
updateTildeReplacementButton();
applyFontSize(globalSettings.fontSize || 12);
applyMode(globalSettings.mode || 'system');
renderNoteList();
 